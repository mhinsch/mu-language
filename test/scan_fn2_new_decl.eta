;; Ref means guaranteed not to be a copy

;; a needs to be a ref so that identity can be compared
a_scan: |(model: Model!, animal: Ref Animal!) =>
	{
	found: (Pos, Bool) find_resource(model.food, animal.pos, m.p.food_visibility)
	
	if` found._1,
		[
		raw_dest: Pos wrap(animal.dest, model.width)
		animal `` disperse 
		movement` model, animal!, raw_dest, [Model.end_move]
		^ ()
		]

	;; shouldn't that be &!, so that refs can be redirected 
	;; (e.g. while resizing the array)?
	;; or build handling of refs into special type of array? 
	;; (but would extend to every container...)
	neighbours: Vec (Ref Animal!, Pos)
	collect_neighbours` model, animal.pos, model.p.visibility, neighbours!
	shuffle` neighbours, rng
	
	each` neighbours, |(na: Ref Animal!, np: Pos) =>
		[ 
		if na === animal, [next ()]

		state: Int na.state

		if` state <>. (Animal.st_run, Animal.st_disperse, Animal.st_fight) &&
			animal.engage,
			[
			if` resolve_encounter(model, animal!, na!, np),
				[^ ()],
			else:
				[
				scan animal
				schedule` model, a!, Model.a_scan, model.p.peace_time
				^ ()
				]
			]
		]
		
	move animal
	movement` model, animal!, found, Model.a_arrive_at_resource
	}

